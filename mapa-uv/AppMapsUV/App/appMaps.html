<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Sistema de Ubicación - Facultad de Ingeniería UV</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* =============================================
           VARIABLES - Paleta UV
           ============================================= */
      :root {
        --uv-blue: #2a4a9c;
        --uv-blue-dark: #1e3a7a;
        --uv-blue-light: #3d5fb8;
        --uv-green: #00b140;
        --uv-green-dark: #009934;
        --uv-green-light: #00d94d;
        --bg: #ffffff;
        --bg-secondary: #f5f7fa;
        --bg-card: #ffffff;
        --text: #1a1a1a;
        --text-secondary: #5a5a5a;
        --text-muted: #888888;
        --border: #e0e4eb;
        --shadow: rgba(42, 74, 156, 0.15);
        --shadow-strong: rgba(42, 74, 156, 0.25);
        --overlay: rgba(30, 58, 122, 0.6);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
        font-family:
          "Poppins",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        overflow: hidden;
      }

      /* =============================================
           HEADER
           ============================================= */
      .app-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 64px;
        background: linear-gradient(
          135deg,
          var(--uv-blue) 0%,
          var(--uv-blue-dark) 100%
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        z-index: 100;
        box-shadow: 0 4px 20px var(--shadow-strong);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-container {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
      }

      .logo-container svg {
        width: 100%;
        height: 100%;
      }

      .app-title-group {
        display: flex;
        flex-direction: column;
      }

      .app-title {
        font-weight: 600;
        font-size: 14px;
        line-height: 1.2;
      }

      .app-subtitle {
        font-weight: 400;
        font-size: 11px;
        opacity: 0.85;
      }

      .header-actions {
        display: flex;
        gap: 8px;
      }

      .btn-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .btn-icon:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
      }

      .btn-icon:active {
        transform: scale(0.95);
      }

      .btn-icon svg {
        width: 20px;
        height: 20px;
      }

      /* =============================================
           MAIN CONTAINER
           ============================================= */
      .app-main {
        padding-top: 64px;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .map-container {
        flex: 1;
        width: 100%;
        background: var(--bg-secondary);
        position: relative;
        overflow: hidden;
      }

      /* =============================================
           SVG DISPLAY
           ============================================= */
      #svgDisplay {
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
      }

      #svgContent {
        width: 100%;
        height: 100%;
        transform-origin: center center;
        cursor: grab;
        transition: transform 0.1s ease-out;
      }

      #svgContent:active {
        cursor: grabbing;
      }

      #svgContent svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      /* =============================================
           CONTROLES DE ZOOM
           ============================================= */
      .controls-zoom {
        position: absolute;
        right: 16px;
        top: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 50;
      }

      .btn-zoom {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--uv-blue);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px var(--shadow);
        transition: all 0.2s ease;
        font-size: 20px;
        font-weight: 600;
      }

      .btn-zoom:hover {
        background: var(--uv-blue);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--shadow-strong);
      }

      .btn-zoom:active {
        transform: scale(0.95);
      }

      /* =============================================
           LOCATION BADGE
           ============================================= */
      .location-badge {
        position: absolute;
        top: 16px;
        left: 16px;
        background: var(--bg);
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 4px 16px var(--shadow);
        z-index: 50;
        border-left: 4px solid var(--uv-green);
        max-width: 200px;
      }

      .location-label {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .location-name {
        font-size: 15px;
        font-weight: 600;
        color: var(--uv-blue-dark);
        margin-top: 2px;
      }

      /* =============================================
           INFO BADGE (Distancia)
           ============================================= */
      .info-badge {
        position: absolute;
        bottom: 100px;
        left: 16px;
        background: var(--bg);
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 4px 16px var(--shadow);
        z-index: 50;
        display: none;
        border: 1px solid var(--border);
      }

      .info-badge.show {
        display: block;
      }

      .info-badge strong {
        color: var(--uv-blue-dark);
        font-size: 12px;
      }

      .info-badge span {
        color: var(--uv-green-dark);
        font-weight: 600;
      }

      /* =============================================
           BOTTOM ACTION BAR
           ============================================= */
      .bottom-action-bar {
        position: fixed;
        left: 16px;
        right: 16px;
        bottom: 24px;
        display: flex;
        gap: 12px;
        z-index: 60;
      }

      .btn-action {
        flex: 1;
        padding: 16px 20px;
        border-radius: 14px;
        border: none;
        font-family: inherit;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 16px var(--shadow);
      }

      .btn-action svg {
        width: 20px;
        height: 20px;
      }

      .btn-action.primary {
        background: linear-gradient(
          135deg,
          var(--uv-green) 0%,
          var(--uv-green-dark) 100%
        );
        color: white;
      }

      .btn-action.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 177, 64, 0.35);
      }

      .btn-action.secondary {
        background: var(--bg);
        color: var(--uv-blue);
        border: 2px solid var(--uv-blue);
      }

      .btn-action.secondary:hover {
        background: var(--uv-blue);
        color: white;
        transform: translateY(-2px);
      }

      .btn-action:active {
        transform: scale(0.98);
      }

      /* =============================================
           MODAL BASE
           ============================================= */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--overlay);
        z-index: 200;
        display: none;
        align-items: flex-end;
        justify-content: center;
        padding: 16px;
        animation: fadeIn 0.2s ease;
      }

      .modal-overlay.show {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: var(--bg);
        border-radius: 20px 20px 16px 16px;
        width: 100%;
        max-width: 420px;
        max-height: 85vh;
        overflow: hidden;
        animation: slideUp 0.3s ease;
        display: flex;
        flex-direction: column;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 20px 20px 16px;
        border-bottom: 1px solid var(--border);
        position: relative;
      }

      .modal-handle {
        width: 40px;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        margin: 0 auto 16px;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--uv-blue-dark);
      }

      .modal-subtitle {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      .modal-close {
        position: absolute;
        top: 20px;
        right: 16px;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: none;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .modal-close:hover {
        background: var(--uv-blue);
        color: white;
      }

      .modal-body {
        padding: 16px 20px;
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer {
        padding: 16px 20px 20px;
        border-top: 1px solid var(--border);
      }

      /* =============================================
           CURRENT LOCATION CARD
           ============================================= */
      .current-location-card {
        background: linear-gradient(
          135deg,
          var(--uv-blue) 0%,
          var(--uv-blue-dark) 100%
        );
        border-radius: 12px;
        padding: 16px;
        color: white;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .current-location-icon {
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .current-location-icon svg {
        width: 24px;
        height: 24px;
      }

      .current-location-text {
        flex: 1;
      }

      .current-location-label {
        font-size: 11px;
        opacity: 0.8;
        font-weight: 500;
      }

      .current-location-name {
        font-size: 16px;
        font-weight: 600;
      }

      /* =============================================
           DESTINATION LIST
           ============================================= */
      .destination-section-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
      }

      .destination-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .destination-item {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
      }

      .destination-item:hover {
        background: white;
        border-color: var(--uv-green);
        transform: translateX(4px);
      }

      .destination-item.selected {
        background: white;
        border-color: var(--uv-green);
      }

      .destination-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .destination-icon.academico {
        background: rgba(42, 74, 156, 0.1);
        color: var(--uv-blue);
      }

      .destination-icon.entrada {
        background: rgba(0, 177, 64, 0.1);
        color: var(--uv-green);
      }

      .destination-icon.investigacion {
        background: rgba(156, 39, 176, 0.1);
        color: #9c27b0;
      }

      .destination-icon svg {
        width: 20px;
        height: 20px;
      }

      .destination-info {
        flex: 1;
      }

      .destination-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
      }

      .destination-type {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .destination-arrow {
        color: var(--text-muted);
      }

      .destination-item:hover .destination-arrow {
        color: var(--uv-green);
      }

      /* =============================================
           SEARCH INPUT
           ============================================= */
      .search-container {
        position: relative;
        margin-bottom: 16px;
      }

      .search-input {
        width: 100%;
        padding: 14px 16px 14px 46px;
        border-radius: 12px;
        border: 2px solid var(--border);
        background: var(--bg);
        font-family: inherit;
        font-size: 14px;
        color: var(--text);
        transition: all 0.2s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--uv-blue);
        box-shadow: 0 0 0 4px rgba(42, 74, 156, 0.1);
      }

      .search-input::placeholder {
        color: var(--text-muted);
      }

      .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
      }

      /* =============================================
           BUILDING INFO MODAL
           ============================================= */
      .building-info-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 20px;
      }

      .building-info-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .building-info-icon.academico {
        background: linear-gradient(
          135deg,
          var(--uv-blue) 0%,
          var(--uv-blue-dark) 100%
        );
        color: white;
      }

      .building-info-icon.investigacion {
        background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
        color: white;
      }

      .building-info-icon.servicio {
        background: linear-gradient(
          135deg,
          var(--uv-green) 0%,
          var(--uv-green-dark) 100%
        );
        color: white;
      }

      .building-info-icon.administrativo {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        color: white;
      }

      .building-info-icon svg {
        width: 28px;
        height: 28px;
      }

      .building-info-title {
        flex: 1;
      }

      .building-info-name {
        font-size: 20px;
        font-weight: 600;
        color: var(--uv-blue-dark);
      }

      .building-info-type {
        font-size: 13px;
        color: var(--text-secondary);
        text-transform: capitalize;
      }

      .floor-section {
        margin-bottom: 16px;
      }

      .floor-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--uv-blue);
        padding: 8px 12px;
        background: rgba(42, 74, 156, 0.08);
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .space-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .space-tag {
        background: var(--bg-secondary);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* =============================================
           LOADER
           ============================================= */
      #map-loader {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 90;
      }

      .spinner {
        width: 56px;
        height: 56px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--uv-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loader-text {
        margin-top: 20px;
        color: var(--uv-blue-dark);
        font-weight: 500;
      }

      /* =============================================
           ROUTE STYLES
           ============================================= */
      .route-polyline {
        fill: none;
        stroke: var(--uv-green);
        stroke-width: 6px;
        stroke-linecap: round;
        stroke-linejoin: round;
        filter: drop-shadow(0 3px 6px rgba(0, 177, 64, 0.3));
      }

      .route-marker {
        fill: var(--uv-green-light);
        stroke: white;
        stroke-width: 2px;
      }

      /* =============================================
           RESPONSIVE
           ============================================= */
      @media (max-width: 380px) {
        .app-title {
          font-size: 12px;
        }

        .app-subtitle {
          font-size: 10px;
        }

        .btn-action {
          padding: 14px 16px;
          font-size: 13px;
        }

        .bottom-action-bar {
          flex-direction: column;
        }
      }

      /* =============================================
           UTILITIES
           ============================================= */
      .hidden {
        display: none !important;
      }

      * {
        -webkit-tap-highlight-color: transparent;
      }

      button {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="app-header">
      <div class="header-left">
        <div class="logo-container">
          <svg viewBox="0 0 100 120" fill="none">
            <!-- Flor de Lis simplificada -->
            <path
              d="M50 5 C50 5 50 35 50 35 C35 25 20 35 20 55 C20 70 35 75 50 95 C65 75 80 70 80 55 C80 35 65 25 50 35 C50 35 50 5 50 5"
              fill="#2A4A9C"
            />
            <path d="M50 40 L35 85 L50 75 L65 85 Z" fill="#00B140" />
          </svg>
        </div>
        <div class="app-title-group">
          <div class="app-title">Sistema de Ubicación</div>
          <div class="app-subtitle">Facultad de Ingeniería</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-icon" id="btnSearch" title="Buscar edificio">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          >
            <circle cx="11" cy="11" r="8" />
            <path d="M21 21l-4.35-4.35" />
          </svg>
        </button>
        <button
          class="btn-icon"
          id="btnAddWaypoint"
          title="Añadir waypoint (clic en el mapa)"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          >
            <path
              d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"
            />
            <circle cx="12" cy="9" r="2.5" />
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Container -->
    <main class="app-main">
      <div class="map-container">
        <!-- Loader -->
        <div id="map-loader">
          <div class="spinner"></div>
          <div class="loader-text">Cargando mapa...</div>
        </div>

        <!-- SVG Display -->
        <div id="svgDisplay">
          <div id="svgContent"></div>
        </div>

        <!-- Zoom Controls -->
        <div class="controls-zoom">
          <button class="btn-zoom" id="zoomIn" title="Acercar">+</button>
          <button class="btn-zoom" id="zoomReset" title="Restablecer">○</button>
          <button class="btn-zoom" id="zoomOut" title="Alejar">−</button>
        </div>

        <!-- Location Badge -->
        <div class="location-badge">
          <div class="location-label">Tu ubicación</div>
          <div class="location-name">Edificio H</div>
        </div>

        <!-- Info Badge -->
        <div class="info-badge" id="infoBadge">
          <strong>Distancia: </strong>
          <span id="distanceInfo">-</span>
        </div>
      </div>

      <!-- Bottom Action Bar -->
      <div class="bottom-action-bar">
        <button class="btn-action secondary" id="btnSearchBuilding">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          >
            <circle cx="11" cy="11" r="8" />
            <path d="M21 21l-4.35-4.35" />
          </svg>
          Buscar Edificio
        </button>
        <button class="btn-action primary" id="btnSelectRoute">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          >
            <path
              d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"
            />
            <circle cx="12" cy="10" r="3" />
          </svg>
          Ir a un destino
        </button>
      </div>
    </main>

    <!-- Modal: Seleccionar Ruta -->
    <div class="modal-overlay" id="modalRoute">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-handle"></div>
          <div class="modal-title">Seleccionar Destino</div>
          <div class="modal-subtitle">
            Calcula la ruta desde tu ubicación actual
          </div>
          <button class="modal-close" id="closeModalRoute">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            >
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <!-- Current Location Card -->
          <div class="current-location-card">
            <div class="current-location-icon">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              >
                <circle cx="12" cy="12" r="10" />
                <circle cx="12" cy="12" r="3" />
              </svg>
            </div>
            <div class="current-location-text">
              <div class="current-location-label">Te encuentras en</div>
              <div class="current-location-name">Edificio H</div>
            </div>
          </div>

          <!-- Destination Selection -->
          <div class="destination-section-title">Elige tu destino</div>
          <div class="destination-list" id="destinationList">
            <!-- Se llena dinámicamente -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn-action primary"
            id="btnStartRoute"
            style="width: 100%"
            disabled
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            >
              <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
            Iniciar Ruta
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Buscar Edificio -->
    <div class="modal-overlay" id="modalSearch">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-handle"></div>
          <div class="modal-title">Buscar Edificio</div>
          <div class="modal-subtitle">
            Encuentra información sobre cualquier edificio
          </div>
          <button class="modal-close" id="closeModalSearch">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            >
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <!-- Search Input -->
          <div class="search-container">
            <svg
              class="search-icon"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="M21 21l-4.35-4.35" />
            </svg>
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="Buscar por nombre o espacio..."
            />
          </div>

          <!-- Building List -->
          <div class="destination-list" id="buildingList">
            <!-- Se llena dinámicamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Info Edificio -->
    <div class="modal-overlay" id="modalBuildingInfo">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-handle"></div>
          <button class="modal-close" id="closeModalInfo">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            >
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="modal-body" id="buildingInfoContent">
          <!-- Se llena dinámicamente -->
        </div>
        <div class="modal-footer">
          <button
            class="btn-action primary"
            id="btnGoToBuilding"
            style="width: 100%"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            >
              <path
                d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"
              />
              <circle cx="12" cy="10" r="3" />
            </svg>
            Ir a este edificio
          </button>
        </div>
      </div>
    </div>

    <script>
      /**
       * ================================================
       * SISTEMA DE UBICACIÓN - FACULTAD DE INGENIERÍA UV
       * ================================================
       */

      // ============================================
      // DATOS DE EDIFICIOS (del JSON)
      // ============================================
      const EDIFICIOS_DATA = {
        edificio_a: {
          nombre: "Edificio A",
          tipo: "academico",
          plantas: {
            1: {
              espacios: [
                "Secretarías (Topografía, Civiles, Mecánicos, Electrónicos, Informáticos, Navales, Arquitectura)",
                "Salón A-11",
                "Salón A-12",
                "Salón A-13",
                "Salón A-14",
                "Salón A-15",
                "Salón A-16",
              ],
            },
            2: {
              espacios: [
                "Salón A-21",
                "Salón A-22",
                "Salón A-23",
                "Salón A-24",
                "Salón A-25",
                "Salón A-26",
              ],
            },
            3: {
              espacios: [
                "Salón A-31",
                "Salón A-32",
                "Salón A-33",
                "Salón A-34",
                "Salón A-35",
              ],
            },
            4: { espacios: [] },
          },
        },
        edificio_b: {
          nombre: "Edificio B",
          tipo: "academico",
          plantas: {
            1: {
              espacios: [
                "Auditorio",
                "Laboratorio de Redes e Información",
                "Centro de Cómputo",
              ],
            },
            2: { espacios: ["Salón B-21", "Salón B-22", "Salón B-23"] },
            3: {
              espacios: [
                "Salón B-31",
                "Salón B-32",
                "Salón B-33",
                "Salón B-34",
              ],
            },
            4: { espacios: [] },
          },
        },
        edificio_c: {
          nombre: "Edificio C",
          tipo: "academico",
          plantas: {
            1: {
              espacios: [
                "Laboratorio de Ingeniería Civil",
                "Laboratorio de Geotecnia L-22",
                "Laboratorio de Materiales",
                "Laboratorio de Pavimentos",
              ],
            },
          },
        },
        edificio_d: {
          nombre: "Edificio D",
          tipo: "administrativo",
          plantas: {
            1: {
              espacios: [
                "Vinculación",
                "Servicio Social FICH",
                "Cubículos",
                "Sala de Maestros (FESAPAUV)",
              ],
            },
          },
        },
        edificio_e: {
          nombre: "Edificio E",
          tipo: "servicio",
          plantas: { 1: { espacios: ["Cafetería"] } },
        },
        edificio_f: {
          nombre: "Edificio F",
          tipo: "academico",
          plantas: {
            1: {
              espacios: [
                "Coordinación de Tutorías y Difusión Cultural",
                "Salón F-11",
                "Salón F-12",
                "Salón F-13",
                "Salón F-14",
                "Salón F-15",
                "Salón F-16",
              ],
            },
            2: {
              espacios: [
                "Salón F-21",
                "Salón F-22",
                "Salón F-23",
                "Salón F-24",
                "Salón F-25",
                "Salón F-26",
              ],
            },
            3: {
              espacios: [
                "Laboratorio de Química",
                "Laboratorio de Ingeniería de Control",
                "Dirección FIEE",
                "Administración FIEE",
                "Secretaría FIEE",
                "Sanitarios",
              ],
            },
          },
        },
        edificio_h: {
          nombre: "Edificio H",
          tipo: "academico",
          plantas: {
            1: {
              espacios: [
                "Aula H-01",
                "Aula H-02",
                "Dirección FICH",
                "Préstamo de Proyectores",
                "Bebedero",
                "Cuarto de Máquinas",
              ],
            },
            2: {
              espacios: ["Aula H-11", "Aula H-12", "Aula H-13", "Aula H-14"],
            },
            3: {
              espacios: [
                "Aula H-21",
                "Aula H-22",
                "Aula H-23",
                "Aula H-24",
                "Salón Audiovisual",
                "Sanitarios",
              ],
            },
          },
        },
        edificio_i: {
          nombre: "Edificio I",
          tipo: "academico",
          plantas: {
            1: {
              espacios: [
                "Salón I-01 A",
                "Salón I-01 B",
                "Salón I-02 A",
                "Salón I-03 A",
                "Salón I-03 B",
                "Laboratorio de Física",
                "Coordinación Centro de Cómputo",
                "Coordinación Ing. Topografía",
                "Coordinación Arquitectura",
              ],
            },
            2: {
              espacios: [
                "Aula Híbrida I-11",
                "Aula Híbrida I-12",
                "Aula Híbrida I-13",
                "Aula Híbrida I-14",
                "Aula Híbrida I-15",
              ],
            },
            3: {
              espacios: [
                "Aula Híbrida I-21",
                "Aula Híbrida I-22",
                "Aula Híbrida I-23",
                "Aula Híbrida I-24",
                "Aula Híbrida I-25",
              ],
            },
          },
        },
        edificio_n: {
          nombre: "Edificio N / MICRONA",
          tipo: "investigacion",
          plantas: {
            1: {
              espacios: [
                "Laboratorio de Óptica",
                "Administración Microna",
                "Salón DMAN",
                "Área de Estudio",
                "Laboratorio de Materiales Avanzados",
                "Dirección Microna",
                "Cubículos de Personal",
              ],
            },
            2: {
              espacios: [
                "Bioestructura",
                "Laboratorio de Confiabilidad",
                "Oficinas Investigadores",
                "Microfabricación",
                "Nanoelectrónica",
                "Síntesis",
                "Catálisis",
                "Diseño de Dispositivos Avanzados",
                "Laboratorio Microeléctrica",
              ],
            },
          },
        },
        cafeteria: {
          nombre: "Cafetería",
          tipo: "servicio",
          plantas: { 1: { espacios: ["Cafetería"] } },
        },
        entrada_ruiz_cortinez: {
          nombre: "Entrada Ruiz Cortinez",
          tipo: "entrada",
          plantas: {
            1: {
              espacios: ["Acceso peatonal principal", "Caseta de vigilancia"],
            },
          },
        },
        entrada_costa_dorada: {
          nombre: "Entrada Costa Dorada",
          tipo: "entrada",
          plantas: { 1: { espacios: ["Acceso secundario", "Tienda Obed"] } },
        },
      };

      // Destinos disponibles desde Edificio H
      const DESTINOS_DISPONIBLES = [
        { id: "edificio_p", nombre: "Edificio P", tipo: "academico" },
        {
          id: "entrada_ruiz_cortinez",
          nombre: "Entrada Ruiz Cortinez",
          tipo: "entrada",
        },
        { id: "edificio_n", nombre: "MICRONA", tipo: "investigacion" },
      ];

      // ============================================
      // ESTADO GLOBAL
      // ============================================
      let scale = 1;
      let translateX = 0;
      let translateY = 0;
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let svgElement = null;
      let routeGroup = null;
      let markerLayer = null;
      let selectedDestination = null;
      let currentBuildingId = null;
      // Enfoque inicial (coordenadas SVG) — cambia aquí para centrar en otra posición
      const initialFocus = { x: 382, y: 409 };

      // ============================================
      // INICIALIZACIÓN
      // ============================================
      document.addEventListener("DOMContentLoaded", init);

      function init() {
        cargarSVG();
        configurarModales();
        configurarEventos();
        llenarDestinos();
        llenarEdificios();
      }

      function cargarSVG() {
        const svgContent = document.getElementById("svgContent");
        // Intentar cargar el SVG (se mostrará placeholder si no existe)
        fetch("../assets/MapUVNew.svg")
          .then((response) => {
            if (!response.ok) throw new Error("SVG no encontrado");
            return response.text();
          })
          .then((svgText) => {
            svgContent.innerHTML = svgText;
            svgElement = svgContent.querySelector("svg");

            if (svgElement) {
              // Crear grupos para rutas y marcadores
              routeGroup = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "g",
              );
              routeGroup.id = "route-layer";
              svgElement.appendChild(routeGroup);

              markerLayer = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "g",
              );
              markerLayer.id = "marker-layer";
              svgElement.appendChild(markerLayer);

              ajustarVistaInicial();

              // Añadir marcador en tiempo real en la coordenada solicitada
              agregarMarcadorTiempoReal(382, 409);
            }

            ocultarLoader();
          })
          .catch((err) => {
            console.warn("No se pudo cargar SVG:", err);
            mostrarPlaceholder();
            ocultarLoader();
          });
      }

      function mostrarPlaceholder() {
        const svgContent = document.getElementById("svgContent");
        svgContent.innerHTML = `
                <svg viewBox="0 0 1056 816" style="width:100%;height:100%;background:#F5F7FA;">
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#E0E4EB" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="1056" height="816" fill="url(#grid)"/>
                    
                    <!-- Placeholder buildings -->
                    <rect x="320" y="180" width="80" height="60" rx="8" fill="#E8EDF5" stroke="#C5D0E0" stroke-width="2"/>
                    <text x="360" y="215" text-anchor="middle" fill="#5a5a5a" font-size="12" font-family="Poppins">Edificio A</text>
                    
                    <rect x="420" y="220" width="80" height="60" rx="8" fill="#E8EDF5" stroke="#C5D0E0" stroke-width="2"/>
                    <text x="460" y="255" text-anchor="middle" fill="#5a5a5a" font-size="12" font-family="Poppins">Edificio B</text>
                    
                    <rect x="280" y="280" width="80" height="60" rx="8" fill="#E8EDF5" stroke="#C5D0E0" stroke-width="2"/>
                    <text x="320" y="315" text-anchor="middle" fill="#5a5a5a" font-size="12" font-family="Poppins">Edificio C</text>
                    
                    <rect x="380" y="320" width="80" height="60" rx="8" fill="#E8EDF5" stroke="#C5D0E0" stroke-width="2"/>
                    <text x="420" y="355" text-anchor="middle" fill="#5a5a5a" font-size="12" font-family="Poppins">Cafetería</text>
                    
                    <rect x="450" y="380" width="80" height="60" rx="8" fill="#E8EDF5" stroke="#C5D0E0" stroke-width="2"/>
                    <text x="490" y="415" text-anchor="middle" fill="#5a5a5a" font-size="12" font-family="Poppins">Edificio F</text>
                    
                    <!-- Edificio H (current location) -->
                    <rect x="300" y="380" width="80" height="60" rx="8" fill="#2A4A9C" stroke="#1E3A7A" stroke-width="2"/>
                    <text x="340" y="415" text-anchor="middle" fill="white" font-size="12" font-family="Poppins" font-weight="600">Edificio H</text>
                    
                    <rect x="500" y="280" width="80" height="60" rx="8" fill="#E8EDF5" stroke="#9C27B0" stroke-width="2"/>
                    <text x="540" y="315" text-anchor="middle" fill="#5a5a5a" font-size="12" font-family="Poppins">MICRONA</text>
                    
                    <!-- Entrada -->
                    <rect x="450" y="160" width="100" height="40" rx="8" fill="#E8F5E9" stroke="#00B140" stroke-width="2"/>
                    <text x="500" y="185" text-anchor="middle" fill="#009934" font-size="11" font-family="Poppins">Entrada Ruiz C.</text>
                    
                    <!-- Current location placeholder removed; se usará marcador en tiempo real -->
                </svg>
            `;
        svgElement = svgContent.querySelector("svg");

        // Crear grupos para rutas y marcadores
        routeGroup = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g",
        );
        routeGroup.id = "route-layer";
        svgElement.appendChild(routeGroup);

        markerLayer = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g",
        );
        markerLayer.id = "marker-layer";
        svgElement.appendChild(markerLayer);

        ajustarVistaInicial();

        // Añadir marcador en tiempo real en la coordenada solicitada
        agregarMarcadorTiempoReal(382, 409);
      }

      function ajustarVistaInicial() {
        const container = document.getElementById("svgDisplay");
        const containerRect = container.getBoundingClientRect();

        const svgWidth = 1056;
        const svgHeight = 816;

        const scaleX = containerRect.width / svgWidth;
        const scaleY = containerRect.height / svgHeight;
        // Aumentar ligeramente el multiplicador para acercar la vista inicial
        scale = Math.min(scaleX, scaleY) * 2.8;

        // Centrar en el punto de interés inicial si está definido
        if (
          initialFocus &&
          typeof initialFocus.x === "number" &&
          typeof initialFocus.y === "number"
        ) {
          translateX = containerRect.width / 2 - initialFocus.x * scale;
          translateY = containerRect.height / 2 - initialFocus.y * scale;
        } else {
          translateX = (containerRect.width - svgWidth * scale) / 2;
          translateY = (containerRect.height - svgHeight * scale) / 2;
        }

        aplicarTransformacion();
      }

      function ocultarLoader() {
        const loader = document.getElementById("map-loader");
        if (loader) {
          loader.style.opacity = "0";
          setTimeout(() => (loader.style.display = "none"), 300);
        }
      }

      // ============================================
      // MODALES
      // ============================================
      function configurarModales() {
        // Modal de ruta
        document
          .getElementById("btnSelectRoute")
          .addEventListener("click", () => {
            document.getElementById("modalRoute").classList.add("show");
          });

        document
          .getElementById("closeModalRoute")
          .addEventListener("click", () => {
            document.getElementById("modalRoute").classList.remove("show");
          });

        document.getElementById("modalRoute").addEventListener("click", (e) => {
          if (e.target.classList.contains("modal-overlay")) {
            document.getElementById("modalRoute").classList.remove("show");
          }
        });

        // Modal de búsqueda
        document
          .getElementById("btnSearchBuilding")
          .addEventListener("click", () => {
            document.getElementById("modalSearch").classList.add("show");
          });

        document.getElementById("btnSearch").addEventListener("click", () => {
          document.getElementById("modalSearch").classList.add("show");
        });

        document
          .getElementById("closeModalSearch")
          .addEventListener("click", () => {
            document.getElementById("modalSearch").classList.remove("show");
          });

        document
          .getElementById("modalSearch")
          .addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              document.getElementById("modalSearch").classList.remove("show");
            }
          });

        // Modal de info edificio
        document
          .getElementById("closeModalInfo")
          .addEventListener("click", () => {
            document
              .getElementById("modalBuildingInfo")
              .classList.remove("show");
          });

        document
          .getElementById("modalBuildingInfo")
          .addEventListener("click", (e) => {
            if (e.target.classList.contains("modal-overlay")) {
              document
                .getElementById("modalBuildingInfo")
                .classList.remove("show");
            }
          });

        // Búsqueda en tiempo real
        document
          .getElementById("searchInput")
          .addEventListener("input", (e) => {
            filtrarEdificios(e.target.value);
          });

        // Botón iniciar ruta
        document
          .getElementById("btnStartRoute")
          .addEventListener("click", iniciarRuta);

        // Botón ir a edificio
        document
          .getElementById("btnGoToBuilding")
          .addEventListener("click", () => {
            if (currentBuildingId) {
              // Verificar si es un destino disponible
              const esDestinoDisponible = DESTINOS_DISPONIBLES.some(
                (d) => d.id === currentBuildingId,
              );
              if (esDestinoDisponible) {
                selectedDestination = currentBuildingId;
                document
                  .getElementById("modalBuildingInfo")
                  .classList.remove("show");
                document.getElementById("modalRoute").classList.add("show");
                actualizarSeleccionDestino();
              } else {
                alert(
                  "Lo sentimos, aún no hay ruta disponible hacia este edificio.",
                );
              }
            }
          });
      }

      // ============================================
      // LLENAR LISTAS
      // ============================================
      function llenarDestinos() {
        const lista = document.getElementById("destinationList");
        lista.innerHTML = "";

        DESTINOS_DISPONIBLES.forEach((destino) => {
          const item = crearItemDestino(destino, true);
          item.addEventListener("click", () => seleccionarDestino(destino.id));
          lista.appendChild(item);
        });
      }

      function llenarEdificios() {
        const lista = document.getElementById("buildingList");
        lista.innerHTML = "";

        Object.entries(EDIFICIOS_DATA).forEach(([id, data]) => {
          const item = crearItemDestino(
            { id, nombre: data.nombre, tipo: data.tipo },
            false,
          );
          item.addEventListener("click", () => mostrarInfoEdificio(id));
          lista.appendChild(item);
        });
      }

      function crearItemDestino(destino, showArrow = true) {
        const div = document.createElement("div");
        div.className = "destination-item";
        div.dataset.id = destino.id;

        const iconClass = destino.tipo || "academico";
        const iconSvg = getIconForType(destino.tipo);

        div.innerHTML = `
                <div class="destination-icon ${iconClass}">
                    ${iconSvg}
                </div>
                <div class="destination-info">
                    <div class="destination-name">${destino.nombre}</div>
                    <div class="destination-type">${getTipoLabel(destino.tipo)}</div>
                </div>
                ${
                  showArrow
                    ? `
                <div class="destination-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </div>
                `
                    : ""
                }
            `;

        return div;
      }

      function getIconForType(tipo) {
        const icons = {
          academico:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
          entrada:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>',
          investigacion:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 2v8l3 3 7-7"/><path d="M14 4.1V2a10 10 0 1 0 7.9 7.9"/></svg>',
          servicio:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
          administrativo:
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
        };
        return icons[tipo] || icons.academico;
      }

      function getTipoLabel(tipo) {
        const labels = {
          academico: "Edificio Académico",
          entrada: "Acceso al Campus",
          investigacion: "Centro de Investigación",
          servicio: "Servicios",
          administrativo: "Administrativo",
        };
        return labels[tipo] || "Edificio";
      }

      function seleccionarDestino(id) {
        selectedDestination = id;
        actualizarSeleccionDestino();
      }

      function actualizarSeleccionDestino() {
        // Quitar selección anterior
        document
          .querySelectorAll("#destinationList .destination-item")
          .forEach((item) => {
            item.classList.remove("selected");
          });

        // Agregar selección actual
        if (selectedDestination) {
          const item = document.querySelector(
            `#destinationList [data-id="${selectedDestination}"]`,
          );
          if (item) {
            item.classList.add("selected");
          }
          document.getElementById("btnStartRoute").disabled = false;
        }
      }

      function filtrarEdificios(query) {
        const lista = document.getElementById("buildingList");
        const items = lista.querySelectorAll(".destination-item");
        const queryLower = query.toLowerCase();

        items.forEach((item) => {
          const nombre = item
            .querySelector(".destination-name")
            .textContent.toLowerCase();
          const id = item.dataset.id;
          const edificio = EDIFICIOS_DATA[id];

          // Buscar también en los espacios
          let encontradoEnEspacios = false;
          if (edificio && edificio.plantas) {
            Object.values(edificio.plantas).forEach((planta) => {
              if (planta.espacios) {
                planta.espacios.forEach((espacio) => {
                  if (espacio.toLowerCase().includes(queryLower)) {
                    encontradoEnEspacios = true;
                  }
                });
              }
            });
          }

          if (nombre.includes(queryLower) || encontradoEnEspacios) {
            item.style.display = "flex";
          } else {
            item.style.display = "none";
          }
        });
      }

      function mostrarInfoEdificio(id) {
        currentBuildingId = id;
        const edificio = EDIFICIOS_DATA[id];
        if (!edificio) return;

        const content = document.getElementById("buildingInfoContent");
        const iconClass = edificio.tipo || "academico";
        const iconSvg = getIconForType(edificio.tipo);

        let plantasHTML = "";
        if (edificio.plantas) {
          Object.entries(edificio.plantas).forEach(([num, planta]) => {
            if (planta.espacios && planta.espacios.length > 0) {
              plantasHTML += `
                            <div class="floor-section">
                                <div class="floor-title">Planta ${num}</div>
                                <div class="space-list">
                                    ${planta.espacios.map((e) => `<span class="space-tag">${e}</span>`).join("")}
                                </div>
                            </div>
                        `;
            }
          });
        }

        content.innerHTML = `
                <div class="building-info-header">
                    <div class="building-info-icon ${iconClass}">
                        ${iconSvg}
                    </div>
                    <div class="building-info-title">
                        <div class="building-info-name">${edificio.nombre}</div>
                        <div class="building-info-type">${getTipoLabel(edificio.tipo)}</div>
                    </div>
                </div>
                ${plantasHTML || '<p style="color: var(--text-secondary); font-size: 14px;">No hay información detallada disponible.</p>'}
            `;

        // Actualizar botón según disponibilidad de ruta
        const btnGoTo = document.getElementById("btnGoToBuilding");
        const esDestinoDisponible = DESTINOS_DISPONIBLES.some(
          (d) => d.id === id,
        );

        if (esDestinoDisponible) {
          btnGoTo.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Ir a este edificio
                `;
          btnGoTo.disabled = false;
          btnGoTo.style.opacity = "1";
        } else {
          btnGoTo.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    Ruta no disponible
                `;
          btnGoTo.disabled = true;
          btnGoTo.style.opacity = "0.5";
        }

        document.getElementById("modalSearch").classList.remove("show");
        document.getElementById("modalBuildingInfo").classList.add("show");
      }

      // ============================================
      // RUTAS
      // ============================================
      function iniciarRuta() {
        if (!selectedDestination) return;

        document.getElementById("modalRoute").classList.remove("show");

        // Simular ruta (en producción usaría las coordenadas reales)
        const destino = DESTINOS_DISPONIBLES.find(
          (d) => d.id === selectedDestination,
        );
        if (destino) {
          dibujarRutaSimulada(destino);
          mostrarDistancia(destino);
        }
      }

      function dibujarRutaSimulada(destino) {
        if (!routeGroup) return;
        routeGroup.innerHTML = "";

        // Coordenadas simuladas desde Edificio H
        const rutas = {
          edificio_p: [
            { x: 382, y: 409 },
            { x: 382, y: 437 },
            { x: 364, y: 473 },
            { x: 342, y: 507 },
            { x: 320, y: 544 },
            { x: 305, y: 550 },
            { x: 295, y: 568 },
            { x: 310, y: 580 },
            { x: 310, y: 590 },
          ],
          entrada_ruiz_cortinez: [
           { x: 382, y: 409 },
            { x: 390, y: 410 },
            {x: 395, y: 400},
            {x: 415, y: 365},
            { x: 435, y: 330 },
            { x: 450, y: 300 },
            { x: 477, y: 250 },
            { x: 490, y: 225 },
          ],
          edificio_n: [
            { x: 382, y: 409 },
            { x: 390, y: 410 },
            {x: 395, y: 400},
            {x: 415, y: 365},
            { x: 435, y: 330 },
            { x: 460, y: 330 },
            { x: 475, y: 325 },
            { x: 488, y: 330},
          ],
        };

        const puntos = rutas[destino.id];
        if (!puntos) return;

        // Crear path
        const pathData = puntos
          .map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`)
          .join(" ");

        // Sombra
        const shadow = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        shadow.setAttribute("d", pathData);
        shadow.setAttribute("fill", "none");
        shadow.setAttribute("stroke", "rgba(0,0,0,0.15)");
        shadow.setAttribute("stroke-width", "10");
        shadow.setAttribute("stroke-linecap", "round");
        shadow.setAttribute("stroke-linejoin", "round");
        routeGroup.appendChild(shadow);

        // Path principal
        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        path.setAttribute("d", pathData);
        path.setAttribute("class", "route-polyline");
        path.setAttribute("stroke-dasharray", "15 10");

        const animate = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "animate",
        );
        animate.setAttribute("attributeName", "stroke-dashoffset");
        animate.setAttribute("from", "0");
        animate.setAttribute("to", "-50");
        animate.setAttribute("dur", "1s");
        animate.setAttribute("repeatCount", "indefinite");
        path.appendChild(animate);

        routeGroup.appendChild(path);

        // Marcador destino
        const fin = puntos[puntos.length - 1];
        crearMarcadorDestino(fin.x, fin.y, destino.nombre);
      }

      function crearMarcadorDestino(x, y, nombre) {
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("transform", `translate(${x}, ${y - 20})`);

        // Pin
        const pin = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        pin.setAttribute(
          "d",
          "M0,-30 C-8,-30 -14,-22 -14,-14 C-14,-6 0,4 0,4 C0,4 14,-6 14,-14 C14,-22 8,-30 0,-30 Z",
        );
        pin.setAttribute("fill", "#00B140");
        pin.setAttribute("stroke", "#fff");
        pin.setAttribute("stroke-width", "2");
        pin.setAttribute("filter", "drop-shadow(0 3px 6px rgba(0,0,0,0.25))");
        g.appendChild(pin);

        // Círculo interior
        const circle = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle",
        );
        circle.setAttribute("cx", "0");
        circle.setAttribute("cy", "-14");
        circle.setAttribute("r", "6");
        circle.setAttribute("fill", "#fff");
        g.appendChild(circle);

        routeGroup.appendChild(g);
      }

      // Marcador en tiempo real estilo Google Maps (añadir/actualizar)
      let realtimeMarker = null;

      function agregarMarcadorTiempoReal(x, y) {
        if (!markerLayer) return;
        if (realtimeMarker) {
          actualizarMarcadorTiempoReal(x, y);
          return;
        }

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.id = "realtime-marker";
        g.setAttribute("transform", `translate(${x}, ${y})`);

        // Pulso
        const pulse = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle",
        );
        pulse.setAttribute("cx", "0");
        pulse.setAttribute("cy", "-17");
        pulse.setAttribute("r", "8");
        pulse.setAttribute("fill", "#1976D2");
        pulse.setAttribute("opacity", "0.6");

        const animR = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "animate",
        );
        animR.setAttribute("attributeName", "r");
        animR.setAttribute("from", "8");
        animR.setAttribute("to", "28");
        animR.setAttribute("dur", "1.6s");
        animR.setAttribute("repeatCount", "indefinite");
        pulse.appendChild(animR);

        const animOp = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "animate",
        );
        animOp.setAttribute("attributeName", "opacity");
        animOp.setAttribute("from", "0.6");
        animOp.setAttribute("to", "0");
        animOp.setAttribute("dur", "1.6s");
        animOp.setAttribute("repeatCount", "indefinite");
        pulse.appendChild(animOp);

        g.appendChild(pulse);

        // Pin
        const pin = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        pin.setAttribute(
          "d",
          "M0,-35 C-10,-35 -18,-27 -18,-17 C-18,-7 0,5 0,5 C0,5 18,-7 18,-17 C18,-27 10,-35 0,-35 Z",
        );
        pin.setAttribute("fill", "#1976D2");
        pin.setAttribute("stroke", "#fff");
        pin.setAttribute("stroke-width", "1.5");
        pin.setAttribute("filter", "drop-shadow(0 3px 6px rgba(0,0,0,0.25))");
        g.appendChild(pin);

        const inner = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle",
        );
        inner.setAttribute("cx", "0");
        inner.setAttribute("cy", "-17");
        inner.setAttribute("r", "6");
        inner.setAttribute("fill", "#fff");
        g.appendChild(inner);

        const center = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle",
        );
        center.setAttribute("cx", "0");
        center.setAttribute("cy", "-17");
        center.setAttribute("r", "3");
        center.setAttribute("fill", "#1976D2");
        g.appendChild(center);

        markerLayer.appendChild(g);
        realtimeMarker = g;

        // Exponer actualización globalmente
        window.updateRealtimeMarker = actualizarMarcadorTiempoReal;
      }

      function actualizarMarcadorTiempoReal(x, y) {
        if (!realtimeMarker) return;
        realtimeMarker.setAttribute("transform", `translate(${x}, ${y})`);
      }

      // ========== Añadir waypoint mediante clic ===========
      let addWaypointMode = false;
      const savedWaypoints = [];

      function toggleAddWaypointMode() {
        addWaypointMode = !addWaypointMode;
        const btn = document.getElementById("btnAddWaypoint");
        if (addWaypointMode) {
          btn.style.background = "rgba(255,255,255,0.12)";
          btn.title = "Modo: clic para añadir waypoint (esc para salir)";
          // Cambiar cursor y añadir listener
          document.getElementById("svgContent").style.cursor = "crosshair";
          (
            svgElement ||
            document.getElementById("svgContent").querySelector("svg")
          ).addEventListener("click", onMapClickAdd);
          // Esc para cancelar
          window.addEventListener("keydown", escCancelAdd);
        } else {
          btn.style.background = "";
          btn.title = "Añadir waypoint (clic en el mapa)";
          document.getElementById("svgContent").style.cursor = "grab";
          (
            svgElement ||
            document.getElementById("svgContent").querySelector("svg")
          ).removeEventListener("click", onMapClickAdd);
          window.removeEventListener("keydown", escCancelAdd);
        }
      }

      function escCancelAdd(e) {
        if (e.key === "Escape") toggleAddWaypointMode();
      }

      function onMapClickAdd(e) {
        // Evitar que el click sea capturado por btns
        if (e.target.closest("button")) return;
        const svg =
          svgElement ||
          document.getElementById("svgContent").querySelector("svg");
        if (!svg) return;
        const rect = svg.getBoundingClientRect();
        const viewBox = svg.viewBox.baseVal;

        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        const scaleX = viewBox.width / rect.width;
        const scaleY = viewBox.height / rect.height;

        const x = Math.round(clickX * scaleX + viewBox.x);
        const y = Math.round(clickY * scaleY + viewBox.y);

        const defaultName = `wp${savedWaypoints.length + 1}`;
        const nombre = prompt("Nombre del waypoint:", defaultName);
        if (!nombre) return;

        addWaypoint(nombre, x, y);
      }

      function addWaypoint(nombre, x, y) {
        savedWaypoints.push({ nombre, x, y });
        drawWaypointMarker(nombre, x, y);
        // Mostrar coordenadas y código para copiar
        const codigo = `    ${nombre}: { x: ${x}, y: ${y} }`;
        alert(
          `Waypoint guardado: ${nombre} (x:${x}, y:${y})\n\nCódigo:\n${codigo}`,
        );
        try {
          navigator.clipboard.writeText(codigo);
        } catch (err) {}
      }

      function drawWaypointMarker(nombre, x, y) {
        if (!markerLayer) {
          markerLayer = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g",
          );
          markerLayer.id = "marker-layer";
          if (svgElement) svgElement.appendChild(markerLayer);
        }

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("transform", `translate(${x}, ${y})`);

        const circle = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "circle",
        );
        circle.setAttribute("cx", "0");
        circle.setAttribute("cy", "0");
        circle.setAttribute("r", "6");
        circle.setAttribute("fill", "#FF9800");
        circle.setAttribute("stroke", "#fff");
        circle.setAttribute("stroke-width", "2");
        g.appendChild(circle);

        const text = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        text.setAttribute("x", "10");
        text.setAttribute("y", "4");
        text.setAttribute("fill", "#333");
        text.setAttribute("font-size", "12");
        text.setAttribute("font-family", "Poppins, sans-serif");
        text.textContent = nombre;
        g.appendChild(text);

        markerLayer.appendChild(g);
      }

      function mostrarDistancia(destino) {
        const distancias = {
          edificio_p: "~3 min",
          entrada_ruiz_cortinez: "~5 min",
          edificio_n: "~4 min",
        };

        const infoBadge = document.getElementById("infoBadge");
        const distanceInfo = document.getElementById("distanceInfo");

        distanceInfo.textContent = distancias[destino.id] || "~5 min";
        infoBadge.classList.add("show");
      }

      function limpiarRuta() {
        if (routeGroup) routeGroup.innerHTML = "";
        selectedDestination = null;
        document.getElementById("infoBadge").classList.remove("show");
        document
          .querySelectorAll("#destinationList .destination-item")
          .forEach((item) => {
            item.classList.remove("selected");
          });
        document.getElementById("btnStartRoute").disabled = true;
      }

      // ============================================
      // EVENTOS DE ZOOM Y PAN
      // ============================================
      function configurarEventos() {
        document
          .getElementById("zoomIn")
          .addEventListener("click", () => zoom(1.3));
        document
          .getElementById("zoomOut")
          .addEventListener("click", () => zoom(0.7));
        document.getElementById("zoomReset").addEventListener("click", () => {
          ajustarVistaInicial();
          limpiarRuta();
        });

        const svgDisplay = document.getElementById("svgDisplay");

        svgDisplay.addEventListener("mousedown", iniciarArrastre);
        svgDisplay.addEventListener("mousemove", arrastrar);
        svgDisplay.addEventListener("mouseup", terminarArrastre);
        svgDisplay.addEventListener("mouseleave", terminarArrastre);
        svgDisplay.addEventListener("wheel", manejarWheel, { passive: false });

        svgDisplay.addEventListener("touchstart", iniciarArrastreTactil, {
          passive: false,
        });
        svgDisplay.addEventListener("touchmove", arrastrarTactil, {
          passive: false,
        });
        svgDisplay.addEventListener("touchend", terminarArrastre);
        // Botón para añadir waypoint
        const btnAdd = document.getElementById("btnAddWaypoint");
        if (btnAdd) btnAdd.addEventListener("click", toggleAddWaypointMode);
      }

      function zoom(factor) {
        const oldScale = scale;
        scale = Math.min(Math.max(0.3, scale * factor), 4);

        const container = document.getElementById("svgDisplay");
        const rect = container.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;

        translateX = centerX - (centerX - translateX) * (scale / oldScale);
        translateY = centerY - (centerY - translateY) * (scale / oldScale);

        aplicarTransformacion();
      }

      function aplicarTransformacion() {
        const svgContent = document.getElementById("svgContent");
        svgContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      }

      function iniciarArrastre(e) {
        if (e.target.closest("button")) return;
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        document.getElementById("svgContent").style.cursor = "grabbing";
      }

      function arrastrar(e) {
        if (!isDragging) return;
        e.preventDefault();
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        aplicarTransformacion();
      }

      function terminarArrastre() {
        isDragging = false;
        document.getElementById("svgContent").style.cursor = "grab";
      }

      function iniciarArrastreTactil(e) {
        if (e.touches.length === 1) {
          isDragging = true;
          startX = e.touches[0].clientX - translateX;
          startY = e.touches[0].clientY - translateY;
        }
      }

      function arrastrarTactil(e) {
        if (!isDragging || e.touches.length !== 1) return;
        e.preventDefault();
        translateX = e.touches[0].clientX - startX;
        translateY = e.touches[0].clientY - startY;
        aplicarTransformacion();
      }

      function manejarWheel(e) {
        e.preventDefault();
        const factor = e.deltaY > 0 ? 0.9 : 1.1;
        zoom(factor);
      }
    </script>
  </body>
</html>
